<!DOCTYPE html>
<html>
<head>
<meta charset="utf8">
<title>Compiler Development</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<style type="text/css">
	pre output:first-child { padding-top: 0; }
</style>
</head>
<body>

<div class="container-fluid">
	<div class="row">
		<section class="col-sm-8 col-sm-offset-2">
			<h2>File Path</h2>
			<div class="input-group">
				<input id="input" type="text" class="form-control" value="test.kit" readonly>
				<div class="input-group-btn">
					<button id="submit" class="btn btn-primary"><i class="fa fa-check"></i> Go</button>
				</div>
			</div>
		</section>
		<section class="col-sm-8 col-sm-offset-2">
			<h2>File Contents</h2>
			<pre><output id="source"></output></pre>
		</section>
		<section class="col-sm-8 col-sm-offset-2">
			<h2>Compiler Result</h2>
			<pre><output id="result"></output></pre>
		</section>
	</div>
</div>
	
<div id="scripts">
<script type="text/javascript" src="compiler.js"></script>
<script type="text/javascript">
	// the elements
	var $input  = document.querySelector('#input')
	var $submit = document.querySelector('#submit')
	var $source = document.querySelector('#source')
	var $result = document.querySelector('#result')
	
	// the file
	var file = {
		  path    : $input.value
		, content : ''
		, error   : false
	}
	
	var files = {}
	
	// get the file
	getFile($input.value).then(
		  function (response) {
			file.content = response
			$submit.onclick()
			files = getFiles(file.path)
		}
		, function (error) {
			file.error = true
			file.content = error
		}
	)
	
	// submit
	$submit.onclick = function () {
		$source.innerHTML = file.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')
		$result.innerHTML = compile(file).compiledCode ? compile(file).compiledCode.replace(/</g, '&lt;').replace(/>/g, '&gt;') : compile(file).resultMessage
	}
	
	// get files
	function getFiles(path) {
		var files = {} // object of files in format { 'name': { path: '', content: '', error: false, files: ['name', 'name'] } }
		var name = path.match(/([^\\\/]+$)/)[0].trim() // gets the string from after the last `/` or `\` 'til the end of the file, trimmed
		
		files[name] = { path: path, content: '', error: null }
		
		var master = getFile(path).then(
			  function (res) {
				files[path] = { content: res }
				findFilePaths(files[path].content)
			}
			, function (err) {
				files[path] = { content: '',  error: err }
			}
		)
		
		function findFilePaths(fileContent) {
			var components = fileContent.match(/(<!--[\t \r\n]@import[\t \r\n=:].*-->)|(<!--[\t \r\n]@include[\t \r\n=:].*-->)/g)
			for (var i = 0; i < components.length; i++) {
				var component    = components[i]
				var commentStart = component.indexOf('<!--')
				var comment      = ''
				
				if (~commentStart) { // this component contains a comment
					comment += component.substring(commentStart) // comment is the component from `<!--` on
					if (/@import|@include/.test(comment)) { // presense of these indicates there is a new file to get
						
					}
				}
			}
		}
	}
	function getFile(path) {
		return new Promise(function (resolve, reject) {
			var request = new XMLHttpRequest()
			request.open('GET', path)
			request.onload = function() {
				if (request.response)
					resolve(request.response)
				else
					reject('Request goofed.')
			}
			request.onerror = function() {
				reject(Error('Network Error'))
			}
			request.send()
		})
	}
</script>
</div>

</body>
</html>
